<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini OS</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror for Code Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>

    <!-- Skulpt for Python Terminal -->
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/skulpt-stdlib.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS for the OS look and feel -->
    <style>
        :root {
            --background-image-url: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop');
            --window-bg: rgba(30, 41, 59, 0.8);
            --taskbar-bg: rgba(15, 23, 42, 0.7);
            --start-menu-bg: rgba(15, 23, 42, 0.85);
            --border-color: rgba(100, 116, 139, 0.5);
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            overflow: hidden;
            user-select: none;
        }

        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: var(--background-image-url);
            background-size: cover;
            background-position: center;
        }

        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            background-color: var(--window-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
        }

        .window-header {
            height: 32px;
            background-color: rgba(0,0,0,0.2);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            flex-shrink: 0;
        }

        .window-content {
            flex-grow: 1;
            padding: 0;
            overflow: auto;
        }
        
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background-color: var(--taskbar-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 10000;
        }

        #start-menu {
            position: absolute;
            bottom: 58px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            height: 550px;
            background-color: var(--start-menu-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 9999;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            pointer-events: none;
        }
        
        #start-menu.open {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
        }
        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .desktop-icon .icon {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }
        .desktop-icon span {
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.8);
        }
        
        /* CodeMirror custom styling */
        .CodeMirror {
            height: 100%;
            font-size: 14px;
            line-height: 1.5;
            background: transparent !important;
        }
        
        .cm-s-dracula.CodeMirror, .cm-s-dracula .CodeMirror-gutters {
            background-color: transparent !important;
        }

        .taskbar-icon {
            position: relative;
            padding: 4px;
            border-radius: 6px;
        }
        .taskbar-icon.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: #38bdf8;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-900">

    <!-- SVG Icon Definitions -->
    <svg width="0" height="0" class="absolute">
        <defs>
            <symbol id="icon-gemini" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="22" x2="12" y2="18"></line><line x1="3.28" y1="16" x2="12" y2="4"></line><line x1="20.72" y1="16" x2="12" y2="4"></line><line x1="17.5" y1="13" x2="6.5" y2="13"></line>
            </symbol>
            <symbol id="icon-terminal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line>
            </symbol>
            <symbol id="icon-text-editor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>
            </symbol>
            <symbol id="icon-code-editor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline>
            </symbol>
             <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </symbol>
            <symbol id="icon-paint" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 2a2 2 0 0 1 2 2v8a2 2 0 0 1-4 0V4a2 2 0 0 1 2-2z"></path><path d="M2.5 13.5a2 2 0 0 1 2-2h15a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-15a2 2 0 0 1-2-2v-2z"></path>
            </symbol>
            <symbol id="icon-snake" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                 <path d="M14.5 9.5a2 2 0 0 1-2-2v0a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2Z"></path><path d="M5.5 11.5a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2v0a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2Z"></path><path d="M12 13.5a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2Z"></path><path d="M13.5 5.5a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2v0a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2Z"></path><path d="m21 15-4-4"></path><path d="m3 9 4 4"></path><path d="M11 21c-2.5 0-4.5-2-4.5-4.5S8.5 12 11 12s4.5 2 4.5 4.5S13.5 21 11 21Z"></path>
            </symbol>
            <symbol id="icon-browser" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="21.17" y1="8" x2="12" y2="8"></line><line x1="3.95" y1="6.06" x2="8.54" y2="14"></line><line x1="10.88" y1="21.94" x2="15.46" y2="14"></line>
            </symbol>
            <symbol id="icon-video" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m22 8-6 4 6 4V8Z"></path><rect x="2" y="6" width="14" height="12" rx="2" ry="2"></rect>
            </symbol>
            <symbol id="icon-calculator" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><line x1="12" y1="10" x2="12" y2="18"></line><line x1="8" y1="10" x2="8" y2="18"></line><line x1="8" y1="14" x2="12" y2="14"></line>
            </symbol>
        </defs>
    </svg>

    <!-- The Desktop Environment -->
    <div id="desktop" class="w-full h-full">
        <div id="desktop-icons" class="absolute top-4 left-4 flex flex-col items-start gap-2">
            <!-- Desktop icons will be generated here by JavaScript -->
        </div>
    </div>

    <!-- The Start Menu -->
    <div id="start-menu">
        <div class="p-6 h-full flex flex-col">
            <div class="relative mb-4">
                <input type="text" placeholder="Search..." class="w-full bg-slate-700/50 border border-slate-600 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div class="flex-grow overflow-y-auto">
                <h2 class="text-slate-400 font-semibold mb-2">Pinned Apps</h2>
                <div id="start-menu-apps" class="grid grid-cols-6 gap-2">
                    <!-- Start Menu apps will be generated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- The Taskbar -->
    <div id="taskbar">
        <div class="flex items-center gap-2">
            <button id="start-button" class="p-2 rounded-md hover:bg-white/10 transition-colors">
                 <svg class="w-6 h-6 text-sky-400"><use xlink:href="#icon-gemini"></use></svg>
            </button>
            <div id="taskbar-apps" class="flex items-center gap-2">
                <!-- Active app icons will go here -->
            </div>
        </div>
        <div id="system-tray" class="flex items-center gap-4 text-sm font-medium text-slate-300">
             <div id="clock"></div>
        </div>
    </div>

    <!-- Window Template (hidden) -->
    <template id="window-template">
        <div class="window" style="top: 150px; left: 150px;">
            <div class="window-header">
                <div class="flex items-center gap-2">
                    <svg class="window-icon w-4 h-4"></svg>
                    <span class="window-title text-sm font-medium">Window</span>
                </div>
                <div class="window-controls flex items-center gap-2">
                    <button class="minimize-btn w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button class="maximize-btn w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    </button>
                    <button class="close-btn w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-500/80 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div class="window-content"></div>
        </div>
    </template>
    
    <script type="module">
        // Gemini OS - Core JavaScript
        
        // --- DOM Elements ---
        const desktop = document.getElementById('desktop');
        const taskbar = document.getElementById('taskbar');
        const taskbarApps = document.getElementById('taskbar-apps');
        const startButton = document.getElementById('start-button');
        const startMenu = document.getElementById('start-menu');
        const clockElement = document.getElementById('clock');
        const desktopIconsContainer = document.getElementById('desktop-icons');
        const startMenuAppsContainer = document.getElementById('start-menu-apps');

        // --- State Management ---
        let highestZIndex = 100;
        const openWindows = new Map();
        let activeWindowId = null;

        // --- Application Definitions ---
        const APPS = {
            'text-editor': { name: 'Text Editor', icon: '#icon-text-editor', content: createTextEditor, desktop: true },
            'terminal': { name: 'Terminal', icon: '#icon-terminal', content: createTerminal, desktop: true },
            'code-editor': { name: 'Code Editor', icon: '#icon-code-editor', content: createCodeEditor, desktop: true },
            'file-explorer': { name: 'File Explorer', icon: '#icon-folder', content: createFileManager, desktop: true },
            'paint': { name: 'Paint', icon: '#icon-paint', content: createPaint, desktop: true },
            'snake-game': { name: 'Snake', icon: '#icon-snake', content: createSnakeGame, desktop: false },
            'browser': { name: 'Browser', icon: '#icon-browser', content: createBrowser, desktop: false },
            'video-player': { name: 'Video Player', icon: '#icon-video', content: createVideoPlayer, desktop: false },
            'calculator': { name: 'Calculator', icon: '#icon-calculator', content: createCalculator, desktop: false },
        };
        
        // --- Virtual File System ---
        let VFS = {
            'C:': {
                'Users': {
                    'Guest': {
                        'Desktop': {},
                        'Documents': {
                            'welcome.txt': 'Welcome to Gemini OS! This is a virtual file system.'
                        },
                        'Pictures': {},
                        'Downloads': {},
                    }
                },
                'System': {
                    'kernel.sys': 'SYSTEM_FILE_DO_NOT_DELETE'
                }
            }
        };
        
        // --- Window Manager ---
        class WindowManager {
            constructor(id, app) {
                this.id = id;
                this.app = app;
                
                const template = document.getElementById('window-template');
                this.element = template.content.cloneNode(true).firstElementChild;
                this.element.dataset.windowId = this.id;
                
                this.header = this.element.querySelector('.window-header');
                this.titleElement = this.element.querySelector('.window-title');
                this.iconElement = this.element.querySelector('.window-icon');
                this.contentElement = this.element.querySelector('.window-content');

                this.element.style.zIndex = ++highestZIndex;
                this.element.style.left = `${100 + (openWindows.size * 25)}px`;
                this.element.style.top = `${100 + (openWindows.size * 25)}px`;

                this.titleElement.textContent = app.name;
                this.iconElement.innerHTML = `<use xlink:href="${app.icon}"></use>`;

                // App-specific content
                app.content(this.contentElement, this);

                this.addEventListeners();
                desktop.appendChild(this.element);
                this.createTaskbarIcon();
                this.focus();
            }

            addEventListeners() {
                // Dragging
                let isDragging = false;
                let dragOffsetX, dragOffsetY;
                this.header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('button')) return;
                    isDragging = true;
                    this.focus();
                    dragOffsetX = e.clientX - this.element.offsetLeft;
                    dragOffsetY = e.clientY - this.element.offsetTop;
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                const onMouseMove = (e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - dragOffsetX;
                    let newY = e.clientY - dragOffsetY;
                    
                    // Constrain to viewport
                    const taskbarHeight = taskbar.offsetHeight;
                    newX = Math.max(0, Math.min(newX, window.innerWidth - this.element.offsetWidth));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - this.element.offsetHeight - taskbarHeight));

                    this.element.style.left = `${newX}px`;
                    this.element.style.top = `${newY}px`;
                };

                const onMouseUp = () => {
                    isDragging = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                // Focus
                this.element.addEventListener('mousedown', () => this.focus());

                // Controls
                this.element.querySelector('.close-btn').addEventListener('click', () => this.close());
                this.element.querySelector('.minimize-btn').addEventListener('click', () => this.minimize());
                this.element.querySelector('.maximize-btn').addEventListener('click', () => this.toggleMaximize());
            }
            
            focus() {
                if (activeWindowId && openWindows.has(activeWindowId)) {
                    openWindows.get(activeWindowId).unfocus();
                }
                
                this.element.style.zIndex = ++highestZIndex;
                activeWindowId = this.id;
                this.taskbarIcon.classList.add('active');
                // You could add a visual effect for the active window here, like a brighter border.
            }

            unfocus() {
                 if (this.taskbarIcon) {
                    this.taskbarIcon.classList.remove('active');
                }
            }

            close() {
                desktop.removeChild(this.element);
                taskbarApps.removeChild(this.taskbarIcon);
                openWindows.delete(this.id);
                 if (activeWindowId === this.id) {
                    activeWindowId = null;
                    // Focus on the next available window if any
                    if (openWindows.size > 0) {
                        const lastWindowId = Array.from(openWindows.keys()).pop();
                        openWindows.get(lastWindowId).focus();
                    }
                }
            }

            minimize() {
                this.element.style.display = 'none';
                this.isMinimized = true;
                this.unfocus();
                 if (activeWindowId === this.id) {
                    activeWindowId = null;
                 }
            }
            
            restore() {
                this.element.style.display = 'flex';
                this.isMinimized = false;
                this.focus();
            }

            toggleMaximize() {
                if (this.isMaximized) {
                    this.element.style.top = this.prevPosition.top;
                    this.element.style.left = this.prevPosition.left;
                    this.element.style.width = this.prevPosition.width;
                    this.element.style.height = this.prevPosition.height;
                    this.isMaximized = false;
                } else {
                    this.prevPosition = {
                        top: this.element.style.top,
                        left: this.element.style.left,
                        width: this.element.style.width,
                        height: this.element.style.height,
                    };
                    this.element.style.top = '0';
                    this.element.style.left = '0';
                    this.element.style.width = '100vw';
                    this.element.style.height = `calc(100vh - ${taskbar.offsetHeight}px)`;
                    this.isMaximized = true;
                }
            }

            createTaskbarIcon() {
                this.taskbarIcon = document.createElement('button');
                this.taskbarIcon.className = 'taskbar-icon p-2 rounded-md hover:bg-white/10 transition-colors';
                this.taskbarIcon.innerHTML = `<svg class="w-6 h-6"><use xlink:href="${this.app.icon}"></use></svg>`;
                this.taskbarIcon.onclick = () => {
                    if (this.isMinimized) {
                        this.restore();
                    } else if (activeWindowId === this.id) {
                        this.minimize();
                    } else {
                        this.focus();
                    }
                };
                taskbarApps.appendChild(this.taskbarIcon);
            }
        }

        // --- App Creation Functions ---

        function createTextEditor(contentElement) {
            contentElement.innerHTML = `<textarea class="w-full h-full bg-transparent border-0 text-slate-200 p-4 focus:outline-none resize-none" spellcheck="false"></textarea>`;
            contentElement.querySelector('textarea').value = 'Start typing...';
        }
        
        function createCodeEditor(contentElement) {
            const textarea = document.createElement('textarea');
            contentElement.appendChild(textarea);
            CodeMirror.fromTextArea(textarea, {
                lineNumbers: true,
                theme: 'dracula',
                mode: 'javascript',
                autoCloseBrackets: true,
            });
        }
        
        function createTerminal(contentElement) {
            contentElement.classList.add('p-2', 'bg-black/50', 'font-mono', 'text-sm');
            contentElement.innerHTML = `
                <div id="terminal-output" class="h-full overflow-y-auto pr-2">
                    <div>Gemini OS [Version 1.0]</div>
                    <div>(c) Gemini Corporation. All rights reserved.</div>
                    <div class="mb-2">Python environment powered by Skulpt.</div>
                </div>
                <div class="flex items-center">
                    <span class="text-green-400">C:\\Users\\Guest></span>
                    <input type="text" id="terminal-input" class="flex-grow bg-transparent border-0 focus:outline-none ml-2">
                </div>
            `;
            
            const output = contentElement.querySelector('#terminal-output');
            const input = contentElement.querySelector('#terminal-input');

            function builtinRead(x) {
                if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                    throw new Error("File not found: '" + x + "'");
                return Sk.builtinFiles["files"][x];
            }

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const command = input.value;
                    const commandEcho = document.createElement('div');
                    commandEcho.innerHTML = `<span class="text-green-400">C:\\Users\\Guest></span> ${command}`;
                    output.appendChild(commandEcho);
                    input.value = '';

                    Sk.configure({ 
                        output: (text) => {
                            const result = document.createElement('pre');
                            result.className = 'whitespace-pre-wrap';
                            result.textContent = text;
                            output.appendChild(result);
                            output.scrollTop = output.scrollHeight;
                        },
                        read: builtinRead
                    });

                    try {
                        Sk.misceval.asyncToPromise(() => Sk.importMainWithBody("<stdin>", false, command, true));
                    } catch (err) {
                        const error = document.createElement('div');
                        error.className = 'text-red-400';
                        error.textContent = err.toString();
                        output.appendChild(error);
                    }
                    output.scrollTop = output.scrollHeight;
                }
            });
        }
        
        function createFileManager(contentElement) {
            contentElement.classList.add('p-2', 'flex', 'flex-col', 'gap-2');
            let currentPath = ['C:', 'Users', 'Guest'];

            const render = () => {
                let currentDir = VFS;
                currentPath.forEach(p => { currentDir = currentDir[p]; });
                
                contentElement.innerHTML = `
                    <div class="path-bar bg-slate-800/50 p-1 rounded-md text-sm">${currentPath.join('\\')}</div>
                    <div class="file-grid flex-grow grid grid-cols-5 gap-2 content-start overflow-y-auto"></div>
                `;
                
                const grid = contentElement.querySelector('.file-grid');
                
                if (currentPath.length > 1) {
                    const upDiv = document.createElement('div');
                    upDiv.className = 'flex flex-col items-center p-2 rounded-md hover:bg-white/10 cursor-pointer';
                    upDiv.innerHTML = `
                        <svg class="w-10 h-10 text-amber-400"><use xlink:href="#icon-folder"></use></svg>
                        <span class="text-xs mt-1 truncate">..</span>`;
                    upDiv.addEventListener('dblclick', () => {
                        currentPath.pop();
                        render();
                    });
                    grid.appendChild(upDiv);
                }

                Object.keys(currentDir).forEach(itemName => {
                    const item = currentDir[itemName];
                    const isFolder = typeof item === 'object';
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex flex-col items-center p-2 rounded-md hover:bg-white/10 cursor-pointer';
                    itemDiv.innerHTML = `
                        <svg class="w-10 h-10 ${isFolder ? 'text-amber-400' : 'text-slate-400'}"><use xlink:href="${isFolder ? '#icon-folder' : '#icon-text-editor'}"></use></svg>
                        <span class="text-xs mt-1 truncate">${itemName}</span>`;

                    if(isFolder) {
                        itemDiv.addEventListener('dblclick', () => {
                            currentPath.push(itemName);
                            render();
                        });
                    } else {
                        // Here you could launch the text editor with file content
                    }
                    grid.appendChild(itemDiv);
                });
            };
            render();
        }

        function createPaint(contentElement) {
            contentElement.innerHTML = `
                <div class="h-full w-full flex flex-col bg-slate-800">
                    <div class="toolbar flex-shrink-0 bg-slate-900/50 p-1 flex items-center gap-2">
                        <input type="color" id="paint-color" value="#FFFFFF">
                        <input type="range" id="paint-brush-size" min="1" max="50" value="5">
                        <button id="paint-clear" class="px-2 py-1 bg-red-500/80 rounded-md text-xs">Clear</button>
                    </div>
                    <canvas id="paint-canvas" class="flex-grow w-full"></canvas>
                </div>
            `;

            const canvas = contentElement.querySelector('#paint-canvas');
            const ctx = canvas.getContext('2d');
            const colorPicker = contentElement.querySelector('#paint-color');
            const sizeSlider = contentElement.querySelector('#paint-brush-size');
            const clearBtn = contentElement.querySelector('#paint-clear');
            
            // Set canvas size
            const resizeCanvas = () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
            
            // Using a timeout because the element might not have its final dimensions immediately
            setTimeout(resizeCanvas, 0); 
            // Optional: You could use a ResizeObserver for more robust resizing.

            let painting = false;

            function startPosition(e) {
                painting = true;
                draw(e);
            }
            function endPosition() {
                painting = false;
                ctx.beginPath();
            }
            function draw(e) {
                if (!painting) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                ctx.lineWidth = sizeSlider.value;
                ctx.lineCap = 'round';
                ctx.strokeStyle = colorPicker.value;

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mouseup', endPosition);
            canvas.addEventListener('mousemove', draw);
            
            clearBtn.addEventListener('click', resizeCanvas);
        }

        function createSnakeGame(contentElement) {
            contentElement.classList.add('bg-gray-900', 'flex', 'items-center', 'justify-center');
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            contentElement.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            let snake = [{ x: 200, y: 200 }];
            let food = { x: 0, y: 0 };
            let dx = 20, dy = 0;
            let score = 0;
            
            function generateFood() {
                food.x = Math.floor(Math.random() * 20) * 20;
                food.y = Math.floor(Math.random() * 20) * 20;
            }

            function draw() {
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw snake
                snake.forEach((part, index) => {
                    ctx.fillStyle = index === 0 ? '#34d399' : '#10b981';
                    ctx.fillRect(part.x, part.y, 20, 20);
                });
                
                // Draw food
                ctx.fillStyle = '#f87171';
                ctx.fillRect(food.x, food.y, 20, 20);
            }
            
            function update() {
                const head = { x: snake[0].x + dx, y: snake[0].y + dy };
                snake.unshift(head);

                if (head.x === food.x && head.y === food.y) {
                    score++;
                    generateFood();
                } else {
                    snake.pop();
                }
                
                // Game over
                if (head.x < 0 || head.x >= 400 || head.y < 0 || head.y >= 400 || snake.slice(1).some(p => p.x === head.x && p.y === head.y)) {
                    snake = [{ x: 200, y: 200 }];
                    dx = 20; dy = 0;
                    score = 0;
                }
                
                draw();
            }

            generateFood();
            setInterval(update, 100);

            document.addEventListener('keydown', e => {
                if (e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -20; }
                if (e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 20; }
                if (e.key === 'ArrowLeft' && dx === 0) { dx = -20; dy = 0; }
                if (e.key === 'ArrowRight' && dx === 0) { dx = 20; dy = 0; }
            });
        }
        
        function createBrowser(contentElement) {
            contentElement.innerHTML = `
                <div class="h-full w-full flex flex-col bg-slate-800">
                    <div class="toolbar flex-shrink-0 bg-slate-900/50 p-1 flex items-center gap-2">
                        <input type="text" id="url-bar" class="w-full bg-slate-700/50 border border-slate-600 rounded-md py-1 px-2 focus:outline-none text-sm" value="https://www.google.com/webhp?igu=1">
                        <button id="go-btn" class="px-2 py-1 bg-sky-500/80 rounded-md text-xs">Go</button>
                    </div>
                    <iframe class="w-full h-full border-0 bg-white" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts"></iframe>
                </div>
            `;
            const urlBar = contentElement.querySelector('#url-bar');
            const goBtn = contentElement.querySelector('#go-btn');
            const iframe = contentElement.querySelector('iframe');
            
            const navigate = () => {
                let url = urlBar.value;
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }
                 // A proxy might be needed for many sites due to X-Frame-Options header
                iframe.src = url;
            };
            
            goBtn.addEventListener('click', navigate);
            urlBar.addEventListener('keydown', e => e.key === 'Enter' && navigate());
            
            navigate(); // Load initial page
        }
        
        function createVideoPlayer(contentElement) {
            contentElement.classList.add('bg-black', 'flex', 'flex-col', 'items-center', 'justify-center', 'p-4', 'gap-4');
            contentElement.innerHTML = `
                <video controls class="max-w-full max-h-[80%] rounded-md"></video>
                <p>Select a local video file to play.</p>
                <input type="file" accept="video/*" class="text-sm">
            `;
            const video = contentElement.querySelector('video');
            const input = contentElement.querySelector('input');
            
            input.addEventListener('change', () => {
                const file = input.files[0];
                if(file) {
                    const url = URL.createObjectURL(file);
                    video.src = url;
                    video.play();
                }
            });
        }
        
        function createCalculator(contentElement) {
            contentElement.classList.add('p-2', 'bg-slate-800');
            contentElement.innerHTML = `
                <div class="w-full h-full grid grid-cols-4 grid-rows-6 gap-1">
                    <div id="calc-display" class="col-span-4 text-3xl text-right p-2 bg-slate-900 rounded-md truncate">0</div>
                    <button class="calc-btn op">C</button>
                    <button class="calc-btn op">()</button>
                    <button class="calc-btn op">%</button>
                    <button class="calc-btn op">/</button>
                    <button class="calc-btn">7</button>
                    <button class="calc-btn">8</button>
                    <button class="calc-btn">9</button>
                    <button class="calc-btn op">*</button>
                    <button class="calc-btn">4</button>
                    <button class="calc-btn">5</button>
                    <button class="calc-btn">6</button>
                    <button class="calc-btn op">-</button>
                    <button class="calc-btn">1</button>
                    <button class="calc-btn">2</button>
                    <button class="calc-btn">3</button>
                    <button class="calc-btn op">+</button>
                    <button class="calc-btn">+/-</button>
                    <button class="calc-btn">0</button>
                    <button class="calc-btn">.</button>
                    <button class="calc-btn op" id="calc-equals">=</button>
                </div>
                <style>
                    .calc-btn { background-color: #475569; border-radius: 6px; }
                    .calc-btn:hover { background-color: #64748b; }
                    .calc-btn.op { background-color: #fb923c; }
                    .calc-btn.op:hover { background-color: #fdba74; }
                </style>
            `;
            
            const display = contentElement.querySelector('#calc-display');
            let currentInput = '0';

            contentElement.querySelectorAll('.calc-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.textContent;
                    if (val === 'C') {
                        currentInput = '0';
                    } else if (val === '=') {
                        try {
                            // Insecure eval, but fine for this context. For a real app, use a math parser.
                            currentInput = String(eval(currentInput.replace(/%/g, '/100')));
                        } catch {
                            currentInput = 'Error';
                        }
                    } else if (val === '+/-') {
                         currentInput = String(parseFloat(currentInput) * -1);
                    } else {
                        if (currentInput === '0' || currentInput === 'Error') {
                            currentInput = val;
                        } else {
                            currentInput += val;
                        }
                    }
                    display.textContent = currentInput;
                });
            });
        }


        // --- App Launcher ---
        function launchApp(appId) {
            const app = APPS[appId];
            if (!app) return;
            
            // If window is already open but minimized, restore it.
            for (const [id, win] of openWindows.entries()) {
                if (win.app.name === app.name && win.isMinimized) {
                    win.restore();
                    return;
                }
            }

            // Create a new window instance
            const windowId = `win-${Date.now()}`;
            const newWindow = new WindowManager(windowId, app);
            openWindows.set(windowId, newWindow);
            closeStartMenu();
        }

        // --- System UI Initialization ---
        
        // Clock
        function updateClock() {
            const now = new Date();
            clockElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();
        
        // Start Menu
        function toggleStartMenu() {
            startMenu.classList.toggle('open');
        }

        function closeStartMenu() {
            startMenu.classList.remove('open');
        }

        startButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleStartMenu();
        });
        document.addEventListener('click', (e) => {
            if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
                closeStartMenu();
            }
        });
        
        // Populate desktop and start menu icons
        function populateIcons() {
             Object.entries(APPS).forEach(([id, app]) => {
                const createAppIcon = (container) => {
                     const iconEl = document.createElement('div');
                     iconEl.className = 'desktop-icon';
                     iconEl.innerHTML = `
                        <svg class="icon"><use xlink:href="${app.icon}"></use></svg>
                        <span>${app.name}</span>
                     `;
                     iconEl.addEventListener('dblclick', () => launchApp(id));
                     container.appendChild(iconEl);
                };
                
                if (app.desktop) {
                    createAppIcon(desktopIconsContainer);
                }
                createAppIcon(startMenuAppsContainer);
            });
        }
        
        // --- Initialization ---
        function init() {
            console.log("Initializing Gemini OS...");
            populateIcons();
        }

        init();
    </script>
</body>
</html>